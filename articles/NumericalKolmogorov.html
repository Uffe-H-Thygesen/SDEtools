<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Numerical Analysis of the Kolmogorov Equations • SDEtools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Numerical Analysis of the Kolmogorov Equations">
<meta property="og:description" content="SDEtools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SDEtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/SDEtools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BrownianMotion.html">Brownian Motion</a>
    </li>
    <li>
      <a href="../articles/FisheriesManagement.html">Fisheries Management - a Numerical Optimal Control Problem</a>
    </li>
    <li>
      <a href="../articles/HMM-filtering-of-scalar-SDEs.html">HMM filtering of scalar SDEs</a>
    </li>
    <li>
      <a href="../articles/ItoIntegrals.html">Itô Integrals and the Euler-Maruyama method</a>
    </li>
    <li>
      <a href="../articles/ItosFormula.html">Itô's formula</a>
    </li>
    <li>
      <a href="../articles/Killing.html">SDEs with killing</a>
    </li>
    <li>
      <a href="../articles/NoisyOscillator.html">The noisy harmonic oscillator</a>
    </li>
    <li>
      <a href="../articles/NumericalKolmogorov.html">Numerical Analysis of the Kolmogorov Equations</a>
    </li>
    <li>
      <a href="../articles/vanderPol.html">A 2D example: The van der Pol oscillator</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Uffe-H-Thygesen/SDEtools/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Numerical Analysis of the Kolmogorov
Equations</h1>
                        <h4 data-toc-skip class="author">Uffe Høgsbro
Thygesen</h4>
            
            <h4 data-toc-skip class="date">2023-07-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Uffe-H-Thygesen/SDEtools/blob/HEAD/vignettes/NumericalKolmogorov.Rmd" class="external-link"><code>vignettes/NumericalKolmogorov.Rmd</code></a></small>
      <div class="hidden name"><code>NumericalKolmogorov.Rmd</code></div>

    </div>

    
    
<p>We consider the numerical analysis of the forward and backward
Kolmogorov equation, using the <em>fvade</em> function (Finite Volume
method for Advection-Diffusion Equations).</p>
<p>Let us start with a toy example. We make a uniform grid on the unit
interval with four grid cells, i.e. five cell boundaries:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Uffe-H-Thygesen/SDEtools" class="external-link">SDEtools</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: SDEtools</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">xi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0.2</span><span class="op">)</span></span>
<span>  <span class="va">xc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cell.centers.html">cell.centers</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xi</span>,<span class="fl">0</span><span class="op">*</span><span class="va">xi</span>,pch<span class="op">=</span><span class="st">"+"</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="st">""</span>,main<span class="op">=</span><span class="st">"The grid"</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="va">xi</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">xc</span>,<span class="fl">0</span><span class="op">*</span><span class="va">xc</span>,pch<span class="op">=</span><span class="st">"o"</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<p>We consider standard Brownian motion on this interval, i.e.  <span class="math display">\[
  \dot \phi = \frac 12 \phi''
\]</span> with reflection at the boundaries, <span class="math inline">\(\phi'(0)=\phi'(1)=0\)</span>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">u</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">0</span></span>
<span>  <span class="va">D</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">0.5</span></span>
<span>  <span class="va">Gd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fvade.html">fvade</a></span><span class="op">(</span><span class="va">u</span>,<span class="va">D</span>,<span class="va">xi</span>,<span class="st">'r'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: Matrix</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Gd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 5 x 5 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">##                                   </span></span>
<span><span class="co">## [1,] -12.5  12.5   .     .     .  </span></span>
<span><span class="co">## [2,]  12.5 -25.0  12.5   .     .  </span></span>
<span><span class="co">## [3,]   .    12.5 -25.0  12.5   .  </span></span>
<span><span class="co">## [4,]   .     .    12.5 -25.0  12.5</span></span>
<span><span class="co">## [5,]   .     .     .    12.5 -12.5</span></span></code></pre>
<p>Note that the discretized version is tri-diagonal (we only jump the
neighbouring states) and symmetric (because the Laplacian is
self-adjoint and the grid is uniform). There is a constant rate of jumps
to “right” cells and the same jump rate to “left” cells, whenever these
cells exist. As a result, the sojourn time - which is found as one
divided with the diagonal entries - is smaller in inner cells than in
boundary cells.</p>
<p>Next, consider pure advection, with constant flow field +1 and no
diffusion: <span class="math display">\[
\dot \phi = - \phi'
\]</span> We still use reflection at the boundaries. From a mathematical
point of view, the boundary becomes a singularity where probability
“piles up”. The discretized equations are:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">u</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span></span>
<span>  <span class="va">D</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">0</span></span>
<span>  <span class="va">Gp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fvade.html">fvade</a></span><span class="op">(</span><span class="va">u</span>,<span class="va">D</span>,<span class="va">xi</span>,<span class="st">'r'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Gp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 5 x 5 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">##                   </span></span>
<span><span class="co">## [1,] -5  5  .  . .</span></span>
<span><span class="co">## [2,]  . -5  5  . .</span></span>
<span><span class="co">## [3,]  .  . -5  5 .</span></span>
<span><span class="co">## [4,]  .  .  . -5 5</span></span>
<span><span class="co">## [5,]  .  .  .  . .</span></span></code></pre>
<p>Note that this corresponds to a Markov chain where we only jump
right, so that the rightmost cell becomes absorbing. Similarly for a
constant flow field -1:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">u</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="fl">1</span></span>
<span>  <span class="va">D</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">0</span></span>
<span>  <span class="va">Gm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fvade.html">fvade</a></span><span class="op">(</span><span class="va">u</span>,<span class="va">D</span>,<span class="va">xi</span>,<span class="st">'r'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Gm</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 5 x 5 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">##                   </span></span>
<span><span class="co">## [1,] .  .  .  .  .</span></span>
<span><span class="co">## [2,] 5 -5  .  .  .</span></span>
<span><span class="co">## [3,] .  5 -5  .  .</span></span>
<span><span class="co">## [4,] .  .  5 -5  .</span></span>
<span><span class="co">## [5,] .  .  .  5 -5</span></span></code></pre>
<div class="section level2">
<h2 id="solution-using-the-matrix-exponential">Solution using the matrix exponential<a class="anchor" aria-label="anchor" href="#solution-using-the-matrix-exponential"></a>
</h2>
<p>We now consider the forward Kolmogorov equation</p>
<p><span class="math display">\[
\dot \phi = \phi'' , \quad \phi(0,x) = \delta(x-x0)
\]</span></p>
<p>on <span class="math inline">\([0,1]\)</span> with reflection at the
boundary <span class="math inline">\(\{0,1\}\)</span>, corresponding to
reflected Brownian motion with intensity <span class="math inline">\(\sigma=\sqrt 2\)</span>. We solve this using the
matrix exponential. This avoids errors arising from time discretization,
but is expensive for large matrices.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">xi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="va">xc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cell.centers.html">cell.centers</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fvade.html">fvade</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fl">0</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fl">1</span>,<span class="va">xi</span>,<span class="st">'r'</span><span class="op">)</span></span>
<span>  <span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">0.01</span></span>
<span>  <span class="va">x0</span> <span class="op">&lt;-</span> <span class="fl">0.25</span></span>
<span>  <span class="va">phi0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">xi</span> <span class="op">&gt;</span> <span class="va">x0</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">phit</span> <span class="op">&lt;-</span> <span class="va">phi0</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">G</span><span class="op">*</span><span class="va">t</span><span class="op">)</span> </span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">phit</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="st">"p.d.f."</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>Note that a probability vector <span class="math inline">\(\phi\)</span> must be multiplied on <span class="math inline">\(G\)</span> (and by extension, on <span class="math inline">\(\exp (Gt)\)</span>) from the left.</p>
</div>
<div class="section level2">
<h2 id="implicit-euler-stepping">Implicit Euler stepping<a class="anchor" aria-label="anchor" href="#implicit-euler-stepping"></a>
</h2>
<p>The matrix exponential is computationally expensive. A simpler
solution is to use an Euler scheme. Explicit Euler is a bad idea, as it
requires a very small time step for stability. So here we use an
implicit Euler step:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Diagonal.html" class="external-link">Diagonal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">xc</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">IGt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">t</span><span class="op">/</span><span class="va">n</span><span class="op">*</span><span class="va">G</span><span class="op">)</span></span>
<span><span class="va">phitEuler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">IGt</span>,<span class="va">phi0</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="va">phitEuler</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/solve-methods.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">IGt</span>,<span class="va">phitEuler</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">phitEuler</span>,type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">phit</span>,lty<span class="op">=</span><span class="st">"dashed"</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>The solver uses the sparsity of the system, so it is quite effective.
Note that the time step we used the Euler method here is quite large, so
that the time discretization error is visible.</p>
</div>
<div class="section level2">
<h2 id="periodic-boundaries">Periodic boundaries<a class="anchor" aria-label="anchor" href="#periodic-boundaries"></a>
</h2>
<p>The previous was done with reflecting boundaries. This imposes that
the flux at the boundary is zero. In this case, where there is only
diffusion, it implies a homogenous Neumann boundary condition of the
forward equation.</p>
<p>We can repeat the study with periodic boundary conditions:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fvade.html">fvade</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fl">0</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fl">1</span>,<span class="va">xi</span>,<span class="st">'p'</span><span class="op">)</span></span>
<span>  <span class="va">phit</span> <span class="op">&lt;-</span> <span class="va">phi0</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">G</span><span class="op">*</span><span class="va">t</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">phit</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="st">"p.d.f."</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>Note that there now is a flux from the left boundary to the
right.</p>
<p>Whether we use periodic or reflecting boundaries, we can find the
stationary distribution:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StationaryDistribution.html">StationaryDistribution</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">rho</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"l"</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1.2</span><span class="op">)</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="st">"p.d.f."</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>As expected, the stationary distribution is uniform.</p>
</div>
<div class="section level2">
<h2 id="absorbing-boundaries">Absorbing boundaries<a class="anchor" aria-label="anchor" href="#absorbing-boundaries"></a>
</h2>
<p>Finally, we can try absorbing boundaries. Here, we have two options:
We can extend the state space with the absorbing boundary points; this
would result in a Markov chain with 102 states (100 inner states and the
two boundary states). In the following, in stead we omit the
boundary.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fvade.html">fvade</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fl">0</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fl">1</span>,<span class="va">xi</span>,<span class="st">'a'</span><span class="op">)</span></span>
<span>  <span class="va">phit</span> <span class="op">&lt;-</span> <span class="va">phi0</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">G</span><span class="op">*</span><span class="va">t</span><span class="op">)</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">phit</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="st">"p.d.f."</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>With absorbing boundaries, the probability inside the domain is not
conserved, but will eventually vanish. So there is no stationary
distribution, but a quasistationary distribution:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/QuasiStationaryDistribution.html">QuasiStationaryDistribution</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">rho</span><span class="op">$</span><span class="va">vector</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"l"</span>,main<span class="op">=</span><span class="va">rho</span><span class="op">$</span><span class="va">value</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="st">"q.s.d."</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>Theoretically, this should be <span class="math inline">\(\sin \pi
x\)</span> (normalized) and the corresponding eigenvalue is <span class="math inline">\(-\pi^2 \approx -9.87\)</span>, i.e., the expected
time to absorption is roughly 0.1 time units, in the quasistationary
state.</p>
</div>
<div class="section level2">
<h2 id="including-both-advection-and-diffusion">Including both advection and diffusion<a class="anchor" aria-label="anchor" href="#including-both-advection-and-diffusion"></a>
</h2>
<p>We now include advection: Add a flow field that directs towards the
center.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">u</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">16</span><span class="op">*</span><span class="op">(</span><span class="fl">0.5</span><span class="op">-</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">D</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span></span>
<span>  <span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fvade.html">fvade</a></span><span class="op">(</span><span class="va">u</span>,<span class="va">D</span>,<span class="va">xi</span>,<span class="st">'r'</span><span class="op">)</span></span></code></pre></div>
<p>As before, the advection is discretized with a first order upwind
scheme:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">G</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 4 x 4 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">##                                 </span></span>
<span><span class="co">## [1,] -10784  10784      .      .</span></span>
<span><span class="co">## [2,]  10000 -20768  10768      .</span></span>
<span><span class="co">## [3,]      .  10000 -20752  10752</span></span>
<span><span class="co">## [4,]      .      .  10000 -20736</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">tail</a></span><span class="op">(</span><span class="va">G</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 4 x 4 sparse Matrix of class "dgCMatrix"</span></span>
<span><span class="co">##         [,97]  [,98]  [,99] [,100]</span></span>
<span><span class="co">##  [97,] -20736  10000      .      .</span></span>
<span><span class="co">##  [98,]  10752 -20752  10000      .</span></span>
<span><span class="co">##  [99,]      .  10768 -20768  10000</span></span>
<span><span class="co">## [100,]      .      .  10784 -10784</span></span></code></pre>
<p>Note that the advection adds extra jumps in the direction of the
advection. This way of discretizing is quite coarse and introduces
numerical diffusion, but it has some important advantages: The
discretized system is the generator of a Markov chain, and this
generator is a linear combination of a generator for the diffusion and
one for the advection. These features make the technique robust and
suitable for demonstration. In a specific application, it could be
worthwhile to explore higher-order methods, but then it must be
carefully checked what properties the discretized system has, and what
the consequences of this are.</p>
<p>We can again plot the stationary distribution:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StationaryDistribution.html">StationaryDistribution</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">rho</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="st">"p.d.f."</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Without boundaries, this would be a Gaussian with mean 0.5 and
variance <span class="math inline">\(1/16\)</span>, i.e. standard
deviation <span class="math inline">\(1/4\)</span>. This is visible in
the solution, although the effect of the boundaries perturb the
solution. Note also that with advection, the no-flux boundary condition
is no longer the same as a homogeneous Neumann condition.</p>
</div>
<div class="section level2">
<h2 id="the-backward-equation">The backward equation<a class="anchor" aria-label="anchor" href="#the-backward-equation"></a>
</h2>
<p>The backward Kolmogorov equation in advection-diffusion form is <span class="math display">\[
-\dot \psi = u \psi ' + (D\psi')'
\]</span> and when we discretize this, it yields the <em>same</em>
generator <span class="math inline">\(G\)</span> as the forward
equation, but now we view the matrix as an operator on column vectors.
For example, we can find the expected value of <span class="math inline">\(X_t\)</span>, as a function of the initial
condition <span class="math inline">\(X_0=x\)</span>:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">psit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">xc</span><span class="op">)</span></span>
<span>  <span class="va">psi0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/expm.html" class="external-link">expm</a></span><span class="op">(</span><span class="va">G</span><span class="op">*</span><span class="va">t</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">psit</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">psi0</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">psi</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="varying-diffusivity">Varying diffusivity<a class="anchor" aria-label="anchor" href="#varying-diffusivity"></a>
</h2>
<p>Keep in mind that when the diffusivity varies in space, the drift
field <span class="math inline">\(f\)</span> in the stochastic
differential equation does not equal the advective field <span class="math inline">\(u\)</span>. Rather, with the SDE <span class="math display">\[
dX_t = f(X_t) ~dt + g(X_t) ~dB_t
\]</span> we have the forward equation <span class="math display">\[
\dot \phi = - (f\phi)' + (\frac 12 g^2 \phi)'' = - (u\phi -
D \phi')'
\]</span> where advection <span class="math inline">\(u\)</span> and
diffusion <span class="math inline">\(D\)</span> can be found from drift
<span class="math inline">\(f\)</span> and noise intensity <span class="math inline">\(g\)</span> as <span class="math display">\[
D = \frac 12 g^2, \quad u = f - D' .
\]</span> The code <em>fvade</em> uses the advection-diffusion
formalism. For example, for stochastic logistic growth where <span class="math inline">\(f(x)=x(1-x)\)</span> and <span class="math inline">\(g(x)= \sigma x\)</span>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span></span>
<span>  <span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">sigma</span> <span class="op">*</span> <span class="va">x</span></span>
<span>  </span>
<span>  <span class="va">gp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">sigma</span> <span class="co">## Implements the derivative g'(x)</span></span>
<span>  <span class="va">D</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu">g</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">Dp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">g</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">*</span><span class="fu">gp</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>  <span class="co">## Implements D'(x)</span></span>
<span>  <span class="va">u</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu">Dp</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">xi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">2</span>,<span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="va">xc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cell.centers.html">cell.centers</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span></span>
<span>  <span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fvade.html">fvade</a></span><span class="op">(</span><span class="va">u</span>,<span class="va">D</span>,<span class="va">xi</span>,<span class="st">'r'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StationaryDistribution.html">StationaryDistribution</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">rho</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="st">"p.d.f."</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="non-equidistant-grids">Non-equidistant grids<a class="anchor" aria-label="anchor" href="#non-equidistant-grids"></a>
</h2>
<p>Sometimes it is an advantage to use higher spatial resolution in some
regions of state space. In this case it is extra important to keep in
mind that <em>fvade</em> works on probabilities of each grid cell, not
densities:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">xi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>,<span class="fl">0.05</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">xc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cell.centers.html">cell.centers</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span></span>
<span>  <span class="va">G</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fvade.html">fvade</a></span><span class="op">(</span><span class="va">u</span>,<span class="va">D</span>,<span class="va">xi</span>,<span class="st">'r'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/StationaryDistribution.html">StationaryDistribution</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">rho</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"x"</span>,ylab<span class="op">=</span><span class="st">"p.d.f."</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">xi</span>,<span class="fl">0</span><span class="op">*</span><span class="va">xi</span>,pch<span class="op">=</span><span class="st">"+"</span><span class="op">)</span></span></code></pre></div>
<p><img src="NumericalKolmogorov_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>This grid is a bit coarse, so the spatial discretization error is
there, but demonstrates the principle.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Uffe Hogsbro Thygesen.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
