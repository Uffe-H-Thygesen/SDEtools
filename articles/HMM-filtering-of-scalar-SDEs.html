<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HMM filtering of scalar SDEs • SDEtools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="HMM filtering of scalar SDEs">
<meta property="og:description" content="SDEtools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SDEtools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/SDEtools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BrownianMotion.html">Brownian Motion</a>
    </li>
    <li>
      <a href="../articles/CoxIngersollRoss.html">The Cox-Ingersoll-Ross process</a>
    </li>
    <li>
      <a href="../articles/FisheriesManagement.html">Fisheries Management - a Numerical Optimal Control Problem</a>
    </li>
    <li>
      <a href="../articles/HMM-filtering-of-scalar-SDEs.html">HMM filtering of scalar SDEs</a>
    </li>
    <li>
      <a href="../articles/ItoIntegrals.html">Itô Integrals and the Euler-Maruyama method</a>
    </li>
    <li>
      <a href="../articles/ItosFormula.html">Itô's formula</a>
    </li>
    <li>
      <a href="../articles/Killing.html">SDEs with killing</a>
    </li>
    <li>
      <a href="../articles/NoisyOscillator.html">The noisy harmonic oscillator</a>
    </li>
    <li>
      <a href="../articles/NumericalKolmogorov.html">Numerical Analysis of the Kolmogorov Equations</a>
    </li>
    <li>
      <a href="../articles/vanderPol.html">A 2D example: The van der Pol oscillator</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Uffe-H-Thygesen/SDEtools/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>HMM filtering of scalar SDEs</h1>
                        <h4 data-toc-skip class="author">Uffe Høgsbro
Thygesen</h4>
            
            <h4 data-toc-skip class="date">2024-05-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Uffe-H-Thygesen/SDEtools/blob/HEAD/vignettes/HMM-filtering-of-scalar-SDEs.Rmd" class="external-link"><code>vignettes/HMM-filtering-of-scalar-SDEs.Rmd</code></a></small>
      <div class="hidden name"><code>HMM-filtering-of-scalar-SDEs.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h3>
<p>We simulate a sample path from the Ito stochastic differential
equation <span class="citation">(Thygesen 2023)</span> governing the
abundance of a bacterial population</p>
<p><span class="math display">\[
dX_t = (1- X_t) ~dt + \gamma \sqrt{X_t} ~dB_t
\]</span></p>
<p>which is the Cox-Ingersoll-Ross model <span class="citation">(Thygesen 2023)</span>. Then, we simulate random
measurements taken at times <span class="math inline">\(0,dt,2~dt,
\ldots, T\)</span> so that <span class="math inline">\(Y_i |
X_{t_i}\)</span> is Poisson distributed with mean <span class="math inline">\(v `. X_{t_i}\)</span>. Then, we pretend that we
don’t know the states and re-estimate them from these measurements. We
do this with the function , so that this vignette is essentially a
demonstration of this function and its use.</p>
</div>
<div class="section level3">
<h3 id="simulation-of-states">Simulation of states<a class="anchor" aria-label="anchor" href="#simulation-of-states"></a>
</h3>
<p>We define the model and simulate the states using the Euler-Maruyama
method.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Uffe-H-Thygesen/SDEtools" class="external-link">SDEtools</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: SDEtools</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span> <span class="co">## For reproducible results</span></span>
<span>  </span>
<span>  <span class="co"># Define model. Note abs to handle negative x.</span></span>
<span>  <span class="va">gamma</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="va">f</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">g</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">gamma</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>;</span>
<span></span>
<span>  <span class="co">## Time vector for simulation</span></span>
<span>  <span class="va">dt</span> <span class="op">=</span> <span class="fl">0.001</span>;</span>
<span>  <span class="va">Tmax</span> <span class="op">=</span> <span class="fl">20</span>;</span>
<span></span>
<span>  <span class="va">tvec</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">Tmax</span>,<span class="va">dt</span><span class="op">)</span></span>
<span>  <span class="va">nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tvec</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Initial condition, chosen somewhat arbitrarily</span></span>
<span>  <span class="va">x0</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span></span>
<span>  <span class="co">## Enforce that the simulated state should be non-negative</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Simulate states </span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/euler.html">euler</a></span><span class="op">(</span><span class="va">f</span>,<span class="va">g</span>,<span class="va">tvec</span>,<span class="va">x0</span>,p<span class="op">=</span><span class="va">p</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">times</span>,<span class="va">sim</span><span class="op">$</span><span class="va">X</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"Time"</span>,ylab<span class="op">=</span><span class="st">'Abundance'</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-1-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="simulation-of-measurements">Simulation of measurements<a class="anchor" aria-label="anchor" href="#simulation-of-measurements"></a>
</h3>
<p>Next, we generate some random measurements. Measurements are taken at
regular points in time; not at every time point where are state values
is simulated. We use a Poisson distribution for the measurements. This
correspond to a situation where we count the number of individuals in a
small sample from the environment.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Generate random measurements</span></span>
<span>  <span class="va">tsample</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span>  <span class="va">vsample</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span>  <span class="va">sampleIndeces</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tvec</span><span class="op">)</span>,<span class="op">(</span><span class="va">tsample</span><span class="op">/</span><span class="va">dt</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">tm</span> <span class="op">=</span> <span class="va">tvec</span><span class="op">[</span><span class="va">sampleIndeces</span><span class="op">]</span>;</span>
<span>  <span class="va">xtrue</span> <span class="op">&lt;-</span> <span class="va">sim</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">sampleIndeces</span><span class="op">]</span></span>
<span>  <span class="va">ymean</span> <span class="op">=</span> <span class="va">vsample</span> <span class="op">*</span> <span class="va">xtrue</span></span>
<span></span>
<span>  <span class="co"># Generate random measurements</span></span>
<span>  <span class="va">ymeas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tm</span><span class="op">)</span>,lambda<span class="op">=</span><span class="va">ymean</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">times</span>,<span class="va">sim</span><span class="op">$</span><span class="va">X</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"Time"</span>,ylab<span class="op">=</span><span class="st">'Abundance'</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">ymeas</span><span class="op">/</span><span class="va">vsample</span>,pch<span class="op">=</span><span class="st">'o'</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Notice that the data is very noisy and, when plotted in this fashion,
does not seem to hold very accurate information about the state.</p>
</div>
<div class="section level3">
<h3 id="specification-of-the-state-likelihood-function">Specification of the state likelihood function<a class="anchor" aria-label="anchor" href="#specification-of-the-state-likelihood-function"></a>
</h3>
<p>To run the filter, we must first specify the state likelihood
function. We first define this for a general measurement and general
state:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">## State likelihood   </span></span>
<span>  <span class="va">dl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">dpois</a></span><span class="op">(</span><span class="va">y</span>,lambda<span class="op">=</span><span class="va">vsample</span><span class="op">*</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p>We can now inspect the state likelihood on its own, i.e., without
using the process equation. We choose a discretization of state space
which has higher resolution near 0, and tabulate the likelihood
function.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">## Choose discretization of state space</span></span>
<span>  <span class="va">xi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span>,<span class="fl">0.025</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span>                                <span class="co"># Cell Interfaces</span></span>
<span>  <span class="va">xc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cell.centers.html">cell.centers</a></span><span class="op">(</span><span class="va">xi</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">ltab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">xc</span>,<span class="va">ymeas</span>,<span class="va">dl</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">xc</span>,<span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">ltab</span><span class="op">)</span>,xlab<span class="op">=</span><span class="st">"Time"</span>,ylab<span class="op">=</span><span class="st">"State"</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>We plot the most likely state, given just the measurements, on top of
the true states:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">xtrue</span>,type<span class="op">=</span><span class="st">"l"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">xc</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">ltab</span>,<span class="fl">2</span>,<span class="va">which.max</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<p>Again, there is very little information in the individual
observation, because the counts are so low. Therefore, there is a
potential gain from estimating the state not just using the measurement
taken at the same time, but also the neighbouring measurements. This is
particularly so because the measurements are taken quite frequently: The
sample interval is 0.1 time unit, while the mean relaxes over a time
scale of 1.</p>
</div>
<div class="section level3">
<h3 id="running-the-filter">Running the filter<a class="anchor" aria-label="anchor" href="#running-the-filter"></a>
</h3>
<p>We now use the filter to add the information from the process
equation. We use the function , which requires a process model as well
as a state likelihood function. In addition, it needs a distribution of
the initial state. We focus first on real-time state estimation; i.e.,
we use only the current and past measurements in the estimation, not
future measurements.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co"># Advection-diffusion form of the Kolmogorov equations</span></span>
<span>  <span class="va">D</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">gamma</span><span class="op">^</span><span class="fl">2</span><span class="op">*</span><span class="va">x</span>;</span>
<span>  <span class="va">u</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">f</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">gamma</span><span class="op">^</span><span class="fl">2</span>;</span>
<span></span>
<span>  <span class="co">## Specify prior c.d.f. of the initial state, here uniform. Note that it does not have to be normalized.</span></span>
<span>  <span class="va">phi0</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span></span>
<span>  <span class="co">## Run the filter </span></span>
<span>  <span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/HMMfilterSDE.html">HMMfilterSDE</a></span><span class="op">(</span><span class="va">u</span>,<span class="va">D</span>,<span class="va">xi</span>,bc<span class="op">=</span><span class="st">'r'</span>,<span class="va">phi0</span>,<span class="va">tm</span>,<span class="va">ymeas</span>,<span class="va">dl</span>,</span>
<span>                         do.Viterbi<span class="op">=</span><span class="cn">TRUE</span>,do.smooth<span class="op">=</span><span class="cn">TRUE</span>,N.sample <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: Matrix</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">## Show colour plot of posterior c.d.f.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">xc</span>,<span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">filter</span><span class="op">$</span><span class="va">psi</span>,<span class="fl">1</span>,<span class="va">cumsum</span><span class="op">)</span><span class="op">)</span>,ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="filtering-results">Filtering results<a class="anchor" aria-label="anchor" href="#filtering-results"></a>
</h3>
<p>We compare the true states with the estimated ones:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">## Plot true state at times of measurements</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">ymean</span><span class="op">/</span><span class="va">vsample</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"t"</span>,ylab<span class="op">=</span><span class="st">"x"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Compute and plot posterior mean</span></span>
<span>  <span class="va">XestMean</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">psi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">xc</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">XestMean</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>Notice how, as anticipated, the estimated states lag a bit behind the
true ones, and that some of the fast fluctuations in the true states do
not reflect in the estimated ones.</p>
<p>We compute the variance in the posterior distribution, at each point
in time:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">XestVar</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">psi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">xc</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">XestMean</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">XestVar</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>Notice how the variance fluctuates significantly in time. This
reflects that both the process equation and the measurement equation has
a variance, which depends on the state. To pursue this further, we can
compare the mean and the variance in the posterior distribution:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">XestMean</span>,<span class="va">XestVar</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<p>Note that there seems to be a roughly linear relationship (save the
first couple of data points, which reflect transients from the initial
condition). This linear relationship reflects both process noise and
measurement noise: When the state is large, the process noise is
increased, and the variance on the measurements is larger.</p>
</div>
<div class="section level3">
<h3 id="the-smoothing-filter">The smoothing filter<a class="anchor" aria-label="anchor" href="#the-smoothing-filter"></a>
</h3>
<p>The filter algorithm outputs both the predicted, estimated, and
smoothed distributions of the state. We now compare how different
information yield different estimates.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">XpredMean</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">phi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">xc</span></span>
<span>  <span class="va">XpredVar</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">phi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">xc</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">XpredMean</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span>  <span class="va">XsmoothMean</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">pi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">xc</span></span>
<span>  <span class="va">XsmoothVar</span> <span class="op">&lt;-</span> <span class="va">filter</span><span class="op">$</span><span class="va">pi</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">xc</span><span class="op">^</span><span class="fl">2</span> <span class="op">-</span> <span class="va">XsmoothMean</span><span class="op">^</span><span class="fl">2</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">t</span>,<span class="va">sim</span><span class="op">$</span><span class="va">X</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"t"</span>,ylab<span class="op">=</span><span class="st">"x"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">XsmoothMean</span>,col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">XestMean</span>,col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,lty<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>,<span class="st">"red"</span>,<span class="st">"blue"</span><span class="op">)</span>,legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"True"</span>,<span class="st">"Smooth"</span>,<span class="st">"Est"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<p>Notice that the difference between the estimated state and the
smoothed state is not very large. In the time interval <span class="math inline">\(t\in[7,10]\)</span>, the smoother is a bit ahead
of the estimator. This is because the true state largely keeps
increasing over this time interval, which keeps surprising the
estimator, but which the smoother takes into account.</p>
<p>We can compare the time-averaged variances between the three state
estimates (predicted, estimated, smoothed). We do this in two ways:
First, we compute the variance in the posterior distributions - this is
the way one would assess variance in e real situation, where the true
states are not available. Second, we compute the time averaged square
deviation between the estimated states and the true ones. This is
clearly only possible since this is a simulation exercise where we know
the truth.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Theo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>Pred <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">XpredVar</span><span class="op">)</span>,Est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">XestVar</span><span class="op">)</span>,Smooth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">XsmoothVar</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Emp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">XpredMean</span><span class="op">-</span><span class="va">xtrue</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">XestMean</span><span class="op">-</span><span class="va">xtrue</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">XsmoothMean</span><span class="op">-</span><span class="va">xtrue</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">Theo</span>,<span class="va">Emp</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">Vars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           Pred       Est    Smooth</span></span>
<span><span class="co">## Theo 0.2954795 0.2082373 0.1449298</span></span>
<span><span class="co">## Emp  0.3369900 0.1850625 0.1118570</span></span></code></pre>
<p>The different between the theoretical variances and the empirical
ones are reasonable and do not show a clear pattern. The difference
between predictions, estimates, and smoothed estimates reflect that more
data points are being used to form the estimates, resulting in a lower
variance.</p>
</div>
<div class="section level3">
<h3 id="the-most-probable-path">The most probable path<a class="anchor" aria-label="anchor" href="#the-most-probable-path"></a>
</h3>
<p>The output from the filter included the most probable path, that is,
the sequence of states which maximize the joint posterior probability.
This is found with the Viterbi algorithm. The following figure shows the
true state, the posterior expectation (based on the smoothing filter,
and the most probable path).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">t</span>,<span class="va">sim</span><span class="op">$</span><span class="va">X</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"t"</span>,ylab<span class="op">=</span><span class="st">"x"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">XsmoothMean</span>,col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">filter</span><span class="op">$</span><span class="va">Xmpt</span>,col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,lty<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>,<span class="st">"red"</span>,<span class="st">"blue"</span><span class="op">)</span>,legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"True"</span>,<span class="st">"Smooth"</span>,<span class="st">"MPT"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>In this example, there is not a very pronounced difference between
the smoothed mean and the most probable track. The most probable track
is systematically slightly below the mean, which is unsurprising given
the skewness in the posterior distributions. However, conceptually there
is quite a big difference in the way they are formed, and if they differ
significantly, this should lead to a closer inspection.</p>
</div>
<div class="section level3">
<h3 id="sampling-typical-tracks">Sampling typical tracks<a class="anchor" aria-label="anchor" href="#sampling-typical-tracks"></a>
</h3>
<p>It is often useful to sample “typical tracks” from the posterior,
i.e., entire state sequences from their joint distribution. These can be
used both to communicate the filter results, and in particular, the
uncertainty on the estimated tracks. Non-specialists often find such
simulated tracks more informative than confidence intervals. Also, the
simulated tracks hold information about conditional autocovariance which
is not captured by the marginal posterior distributions provided by the
smoothing filter, so they can be used for Monte Carlo estimation of
statistics such as the posterior probability that the state enters a
given region.</p>
<p>The following code compares the true track with the Most Probable
Track and a few (3) simulated typical tracks from the posterior.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">t</span>,<span class="va">sim</span><span class="op">$</span><span class="va">X</span>,type<span class="op">=</span><span class="st">"l"</span>,xlab<span class="op">=</span><span class="st">"t"</span>,ylab<span class="op">=</span><span class="st">"x"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">filter</span><span class="op">$</span><span class="va">Xtyp</span>,col<span class="op">=</span><span class="st">"red"</span>,type<span class="op">=</span><span class="st">"l"</span>,add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">tm</span>,<span class="va">filter</span><span class="op">$</span><span class="va">Xmpt</span>,col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>,lty<span class="op">=</span><span class="fl">1</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>,<span class="st">"red"</span>,<span class="st">"blue"</span><span class="op">)</span>,legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"True"</span>,<span class="st">"Typical"</span>,<span class="st">"MPT"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="HMM-filtering-of-scalar-SDEs_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="perspectives">Perspectives<a class="anchor" aria-label="anchor" href="#perspectives"></a>
</h3>
<p>It is possible to estimate the states between the measurements, for
example by having a state likelihood function which is constant to 1
whenever no measurement is taken. Then, you could investigate how the
posterior variance evolves between times of measurements.</p>
<p>The function gives various output that can be used to assess model
fit: The total log-likelihood can be used in an “outer loop” to estimate
model parameters using the Maximum Likelihood principle, and describes
how well, on average, the model does one-step predictions. The
normalization constants <span class="math inline">\(c\)</span> apply to
each time step, and can be used to identify observations that were very
unexpected, and therefore potential outliers. This can be refined using
the prediction pseudo-residuals <span class="math inline">\(U\)</span>,
which theoretically should be independent and uniformly distributed on
[0,1]; this can be used for model validation.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Thygesen2023sde" class="csl-entry">
Thygesen, Uffe Høgsbro. 2023. <em>Stochastic Differential Equations for
Science and Engineering</em>. Taylor &amp; Francis. <a href="http://uffe-h-thygesen.github.io" class="external-link">http://uffe-h-thygesen.github.io</a>.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Uffe Hogsbro Thygesen.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
